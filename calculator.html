<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidrapport med L√∂neber√§kning</title>
        <link rel="stylesheet" href="/css/calculator.css">
</head>
<body>
    <div class="topbar">
        <h2>Navigation</h2>
        <ul>
            <li><a href="/index.html">Hem</a></li>
            <li><a href="/calculator.html">Butik Kalkylator</a></li>
            <li><a href="/calculatorv2.html">Kalkylator v2</a></li>
        </ul>
    </div>
    <div class="container">
        <h1>üìä Tidrapport med L√∂neber√§kning och OB-till√§gg</h1>
        <div style="text-align: center; margin-bottom: 20px; font-size: 1.1em; color: #666;">
            <span id="currentTime"></span>
        </div>
        
        <div class="settings-section">
            <h3>L√∂ne- och OB-inst√§llningar</h3>
            <div class="settings-row">
                <label for="basePay">Grundl√∂n (kr/tim):</label>
                <input type="number" id="basePay" value="162.98" step="0.01" min="0">
            </div>
            <div class="settings-row">
                <label for="eveningRate">Vardagar fr√•n 18:15 (50%):</label>
                <input type="number" id="eveningRate" value="50" step="0.01" min="0" max="200"> <span>% av grundl√∂n</span>
            </div>
            <div class="settings-row">
                <label for="lateEveningRate">Vardagar efter 20:00 (70%):</label>
                <input type="number" id="lateEveningRate" value="70" step="0.01" min="0" max="200"> <span>% av grundl√∂n</span>
            </div>
            <div class="settings-row">
                <label for="saturdayRate">L√∂rdag fr√•n 12:00 (100%):</label>
                <input type="number" id="saturdayRate" value="100" step="0.01" min="0" max="200"> <span>% av grundl√∂n</span>
            </div>
            <div class="settings-row">
                <label for="sundayRate">S√∂ndag hela dagen (100%):</label>
                <input type="number" id="sundayRate" value="100" step="0.01" min="0" max="200"> <span>% av grundl√∂n</span>
            </div>
            <div class="settings-row">
                <label for="holidayRate">Helgtill√§gg (100%):</label>
                <input type="number" id="holidayRate" value="100" step="0.01" min="0" max="200"> <span>% av grundl√∂n</span>
            </div>
            <div class="settings-row">
                <label for="taxRate">Skattesats (%):</label>
                <input type="number" id="taxRate" value="30" step="0.01" min="0" max="100"> <span>% av bruttol√∂n</span>
            </div>
        </div>

        <div class="ob-legend">
            <h3>OB-till√§gg f√∂rklaring:</h3>
            <p><strong>Vardagar fr√•n 18:15:</strong> 50% av grundl√∂n (m√•ndag-fredag)</p>
            <p><strong>Vardagar efter 20:00:</strong> 70% av grundl√∂n (m√•ndag-fredag)</p>
            <p><strong>L√∂rdag fr√•n 12:00:</strong> 100% av grundl√∂n</p>
            <p><strong>S√∂ndag hela dagen:</strong> 100% av grundl√∂n</p>
            <p><strong>Helgtill√§gg:</strong> 100% av grundl√∂n (alla timmar p√• helgdagar)</p>
            <p><strong>R√∂d dag:</strong> Kryssa i f√∂r att r√§kna dagen som helgdag (100% till√§gg). Systemet f√∂rs√∂ker f√∂rfylla baserat p√• svenska helgdagar 2025 och s√∂ndagar.</p>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="addDay()">‚ûï L√§gg till dag</button>
            <button class="btn" onclick="calculateAll()">üîÑ Ber√§kna totalt</button>
            <button class="btn" onclick="exportData()">üì§ Exportera data</button>
            <button class="btn" onclick="saveData()">üíæ Spara data</button>
            <button class="btn" onclick="clearAllData()">üóëÔ∏è Rensa all data</button>
        </div>

        <div class="day-table-container">
            <table id="timeReportTable">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Dag</th>
                        <th>R√∂d dag</th>
                        <th>Starttid</th>
                        <th>Sluttid</th>
                        <th>Rast (min)</th>
                        <th>Arbetstid</th>
                        <th>Grundl√∂n</th>
                        <th>OB-till√§gg</th>
                        <th>Brutto</th>
                        <th>Skatt</th>
                        <th>Netto</th>
                        <th>√Ötg√§rder</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="summary">
            <h3>üìà M√•nadssummering</h3>
            <div class="summary-row">
                <span>Totala arbetstimmar:</span>
                <span id="totalHours">0.0</span>
            </div>
            <div class="summary-row">
                <span>Grundl√∂n (exkl. OB):</span>
                <span id="totalBasePay">0 kr</span>
            </div>
            <div class="summary-row">
                <span>OB-till√§gg - Vardag kv√§ll (18:15):</span>
                <span id="totalEveningPay">0 kr</span>
            </div>
            <div class="summary-row">
                <span>OB-till√§gg - Vardag sen kv√§ll (20:00):</span>
                <span id="totalLateEveningPay">0 kr</span>
            </div>
            <div class="summary-row">
                <span>OB-till√§gg - L√∂rdag (fr√•n 12:00):</span>
                <span id="totalSaturdayPay">0 kr</span>
            </div>
            <div class="summary-row">
                <span>OB-till√§gg - S√∂ndag:</span>
                <span id="totalSundayPay">0 kr</span>
            </div>
            <div class="summary-row">
                <span>OB-till√§gg - Helgdagar:</span>
                <span id="totalHolidayPay">0 kr</span>
            </div>
            <div class="summary-row total">
                <span>BRUTTOL√ñN:</span>
                <span id="grandTotal">0 kr</span>
            </div>
            <div class="summary-row tax-section">
                <span>Skatt (<span id="taxRateDisplay">30</span>%):</span>
                <span id="totalTax">0 kr</span>
            </div>
            <div class="summary-row total">
                <span>NETTOL√ñN (efter skatt):</span>
                <span id="netTotal">0 kr</span>
            </div>
        </div>
    </div>

    <script>
        let dayCounter = 0; // Unique ID for each day row
        let allDaysData = {}; // Object to store data for each day, keyed by unique ID

        // Svenska helgdagar 2025. Uppdatera denna lista √•rligen.
        const holidays = [
            '2025-01-01', '2025-01-06', '2025-04-18', '2025-04-19', '2025-04-20', '2025-04-21', 
            '2025-05-01', '2025-05-29', '2025-06-06', '2025-06-20', '2025-06-21', // Midsommarafton, Midsommardagen
            '2025-11-01', // Alla helgons dag
            '2025-12-24', '2025-12-25', '2025-12-26'
        ];

        // --- Helper Functions ---

        /**
         * Converts a time string (e.g., "09:00") to minutes from midnight.
         * @param {string} timeStr - The time string.
         * @returns {number} Minutes from midnight.
         */
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        /**
         * Converts minutes to hours (e.g., 90 minutes -> 1.5 hours).
         * @param {number} minutes - The number of minutes.
         * @returns {number} Hours.
         */
        function minutesToHours(minutes) {
            return minutes / 60;
        }

        /**
         * Formats a Date object to 'YYYY-MM-DD' string.
         * @param {Date} date - The date object.
         * @returns {string} Formatted date string.
         */
        function formatDateToISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Updates the current time display.
         */
        function updateClock() {
            const now = new Date();
            const options = {
                timeZone: 'Europe/Stockholm',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                weekday: 'long'
            };
            const formatter = new Intl.DateTimeFormat('sv-SE', options);
            document.getElementById('currentTime').textContent = `üïê ${formatter.format(now)}`;
        }
        
        // --- Core UI Management ---

        /**
         * Adds a new day row to the table.
         */
        function addDay() {
            const tableBody = document.querySelector('#timeReportTable tbody');
            const newDayId = `day_${dayCounter++}`;
            const today = formatDateToISO(new Date());

            allDaysData[newDayId] = { date: today, start: '', end: '', break: 0, redDay: false }; // Initialize data

            const newRow = tableBody.insertRow();
            newRow.id = `row_${newDayId}`;

            // Check if today is a holiday or Sunday for initial red day status
            const currentDayDateObj = new Date(today);
            const isSunday = currentDayDateObj.getDay() === 0;
            const isHoliday = holidays.includes(today);
            const initialRedDay = isSunday || isHoliday;
            
            // Apply initial weekend/red-day styling
            if (isSunday || currentDayDateObj.getDay() === 6) { // Sunday or Saturday
                newRow.classList.add('weekend');
            }
            if (initialRedDay) {
                newRow.classList.add('red-day');
            }
            allDaysData[newDayId].redDay = initialRedDay; // Update stored data

            newRow.innerHTML = `
                <td><input type="date" class="input-field" id="date_${newDayId}" value="${today}" onchange="updateDayData('${newDayId}');"></td>
                <td id="dayName_${newDayId}">${new Intl.DateTimeFormat('sv-SE', { weekday: 'long' }).format(currentDayDateObj)}</td>
                <td><input type="checkbox" class="checkbox-field" id="redDay_${newDayId}" ${initialRedDay ? 'checked' : ''} onchange="updateRedDay('${newDayId}'); saveData();"></td>
                <td><input type="time" class="input-field" id="start_${newDayId}" onchange="calculateRow('${newDayId}'); saveData();"></td>
                <td><input type="time" class="input-field" id="end_${newDayId}" onchange="calculateRow('${newDayId}'); saveData();"></td>
                <td><input type="number" class="input-field" id="break_${newDayId}" value="0" min="0" onchange="calculateRow('${newDayId}'); saveData();"></td>
                <td id="hours_${newDayId}">0.0</td>
                <td id="basePay_${newDayId}">0 kr</td>
                <td id="obPay_${newDayId}">0 kr</td>
                <td id="total_${newDayId}">0 kr</td>
                <td id="tax_${newDayId}">0 kr</td>
                <td id="net_${newDayId}">0 kr</td>
                <td><button class="remove-day-btn" onclick="removeDay('${newDayId}')">X</button></td>
            `;

            saveData(); // Save data after adding a day
            calculateAll(); // Recalculate totals
        }

        /**
         * Updates the day name and red day status for a row when date input changes.
         * @param {string} dayId - The unique ID of the day row.
         */
        function updateDayData(dayId) {
            const dateInput = document.getElementById(`date_${dayId}`);
            const dayNameCell = document.getElementById(`dayName_${dayId}`);
            const redDayCheckbox = document.getElementById(`redDay_${dayId}`);
            const row = document.getElementById(`row_${dayId}`);

            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday...
                const dateISO = formatDateToISO(date);

                dayNameCell.textContent = new Intl.DateTimeFormat('sv-SE', { weekday: 'long' }).format(date);
                
                // Determine initial redDay status
                const isSunday = dayOfWeek === 0;
                const isHoliday = holidays.includes(dateISO);
                redDayCheckbox.checked = isSunday || isHoliday;
                
                // Update row styling
                row.classList.remove('weekend', 'red-day');
                if (isSunday || dayOfWeek === 6) { // Sunday or Saturday
                    row.classList.add('weekend');
                }
                if (redDayCheckbox.checked) {
                    row.classList.add('red-day');
                }

                allDaysData[dayId].date = dateInput.value; // Update stored date
                allDaysData[dayId].redDay = redDayCheckbox.checked; // Update stored redDay status
                calculateRow(dayId); // Recalculate row based on new date/redDay status
                saveData();
            }
        }

        /**
         * Updates the red day status and styling for a row based on checkbox.
         * @param {string} dayId - The unique ID of the day row.
         */
        function updateRedDay(dayId) {
            const row = document.getElementById(`row_${dayId}`);
            const redDayCheckbox = document.getElementById(`redDay_${dayId}`);
            const dateInput = document.getElementById(`date_${dayId}`);
            
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                // Update row styling
                row.classList.remove('weekend', 'red-day'); // Reset classes
                if (redDayCheckbox.checked) {
                    row.classList.add('red-day');
                } else if (isWeekend) {
                    row.classList.add('weekend');
                }
                
                allDaysData[dayId].redDay = redDayCheckbox.checked; // Update stored data
                calculateRow(dayId);
            }
        }

        /**
         * Calculates the OB time for a given work period.
         * Handles overnight shifts and various OB rules.
         * @param {number} startMinutesOfDay1 - Start time in minutes from midnight (day 1).
         * @param {number} endMinutesOfDay1 - End time in minutes from midnight (day 1).
         * @param {Date} dateObj - The date object for the work day.
         * @param {number} workMinutes - Total actual work minutes.
         * @param {boolean} isRedDay - True if the day is marked as a red day/holiday.
         * @returns {Object} An object with minutes for each OB category.
         */
        function calculateOB(startMinutesOfDay1, endMinutesOfDay1, dateObj, workMinutes, isRedDay) {
            let eveningMinutes = 0;
            let lateEveningMinutes = 0;
            let saturdayMinutes = 0;
            let sundayMinutes = 0;
            let holidayMinutes = 0;

            const dayOfWeek = dateObj.getDay(); // 0=s√∂ndag, 1=m√•ndag, ..., 6=l√∂rdag

            if (workMinutes <= 0) {
                return { evening: 0, lateEvening: 0, saturday: 0, sunday: 0, holiday: 0 };
            }

            // If it's marked as red day, all work time gets holiday rate
            if (isRedDay) {
                holidayMinutes = workMinutes;
                return { evening: 0, lateEvening: 0, saturday: 0, sunday: 0, holiday: holidayMinutes };
            }

            // If it's Sunday, all work time gets Sunday rate (100%)
            if (dayOfWeek === 0) { // Sunday
                sundayMinutes = workMinutes;
                return { evening: 0, lateEvening: 0, saturday: 0, sunday: sundayMinutes, holiday: 0 };
            }

            // If it's Saturday, calculate from 12:00 (100%)
            if (dayOfWeek === 6) { // Saturday
                const saturdayOBStart = 12 * 60; // 12:00 in minutes
                const workStart = startMinutesOfDay1;
                const workEnd = endMinutesOfDay1;

                // Calculate overlap with Saturday OB period (12:00 to 24:00)
                const obStartActual = Math.max(workStart, saturdayOBStart);
                const obEndActual = Math.min(workEnd, 24 * 60); // Ensure it doesn't go past midnight for calculation on current day
                
                saturdayMinutes = Math.max(0, obEndActual - obStartActual);
                
                return { evening: 0, lateEvening: 0, saturday: saturdayMinutes, sunday: 0, holiday: 0 };
            }

            // Weekdays (Monday-Friday): Calculate OB rates
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                const eveningOBStart = 18 * 60 + 15; // 18:15
                const lateEveningOBStart = 20 * 60; // 20:00

                const workStart = startMinutesOfDay1;
                const workEnd = endMinutesOfDay1;

                // Calculate evening OB (18:15 - 19:59)
                const eveningOverlapStart = Math.max(workStart, eveningOBStart);
                const eveningOverlapEnd = Math.min(workEnd, lateEveningOBStart);
                eveningMinutes = Math.max(0, eveningOverlapEnd - eveningOverlapStart);

                // Calculate late evening OB (20:00 - 24:00)
                const lateEveningOverlapStart = Math.max(workStart, lateEveningOBStart);
                const lateEveningOverlapEnd = Math.min(workEnd, 24 * 60); // Max to midnight
                lateEveningMinutes = Math.max(0, lateEveningOverlapEnd - lateEveningOverlapStart);
            }

            return {
                evening: eveningMinutes,
                lateEvening: lateEveningMinutes,
                saturday: saturdayMinutes,
                sunday: sundayMinutes,
                holiday: holidayMinutes
            };
        }
        
        /**
         * Calculates the pay for a single row (day).
         * @param {string} dayId - The unique ID of the day row.
         */
        function calculateRow(dayId) {
            const startInput = document.getElementById(`start_${dayId}`);
            const endInput = document.getElementById(`end_${dayId}`);
            const breakInput = document.getElementById(`break_${dayId}`);
            const dateInput = document.getElementById(`date_${dayId}`);
            const redDayCheckbox = document.getElementById(`redDay_${dayId}`);

            let currentDayData = allDaysData[dayId];

            // Reset error class
            startInput.classList.remove('error');
            endInput.classList.remove('error');

            if (!startInput.value || !endInput.value || !dateInput.value) {
                // Clear display if inputs are incomplete
                document.getElementById(`hours_${dayId}`).textContent = '0.0';
                document.getElementById(`basePay_${dayId}`).textContent = '0 kr';
                document.getElementById(`obPay_${dayId}`).textContent = '0 kr';
                document.getElementById(`total_${dayId}`).textContent = '0 kr';
                document.getElementById(`tax_${dayId}`).textContent = '0 kr';
                document.getElementById(`net_${dayId}`).textContent = '0 kr';
                
                // Update stored data (clear calculated fields)
                currentDayData.start = startInput.value;
                currentDayData.end = endInput.value;
                currentDayData.break = parseInt(breakInput.value) || 0;
                currentDayData.workHours = 0;
                currentDayData.basePayAmount = 0;
                currentDayData.obTotal = 0;
                currentDayData.totalPay = 0;
                currentDayData.taxAmount = 0;
                currentDayData.netPay = 0;
                currentDayData.obBreakdown = {};

                calculateAll(); // Update total summary
                return;
            }

            const startMinutes = timeToMinutes(startInput.value);
            let endMinutes = timeToMinutes(endInput.value);
            const breakMinutes = parseInt(breakInput.value) || 0;
            const dateObj = new Date(dateInput.value);
            const isRedDay = redDayCheckbox.checked;
            
            let workMinutes = 0;
            let overnight = false;

            // Handle overnight shifts (end time is smaller than start time, means next day)
            if (endMinutes <= startMinutes) {
                workMinutes = (24 * 60 - startMinutes) + endMinutes;
                overnight = true;
            } else {
                workMinutes = endMinutes - startMinutes;
            }

            workMinutes -= breakMinutes;
            
            // Basic validation: If work minutes become negative or zero after valid times
            if ((!overnight && endMinutes < startMinutes) || (workMinutes < 0 && (startInput.value && endInput.value))) {
                startInput.classList.add('error');
                endInput.classList.add('error');
                document.getElementById(`hours_${dayId}`).textContent = 'Ogiltig tid!';
                // Clear dependent fields
                document.getElementById(`basePay_${dayId}`).textContent = '0 kr';
                document.getElementById(`obPay_${dayId}`).textContent = '0 kr';
                document.getElementById(`total_${dayId}`).textContent = '0 kr';
                document.getElementById(`tax_${dayId}`).textContent = '0 kr';
                document.getElementById(`net_${dayId}`).textContent = '0 kr';
                
                // Store incomplete data
                currentDayData.start = startInput.value;
                currentDayData.end = endInput.value;
                currentDayData.break = breakMinutes;
                currentDayData.workHours = 0;
                currentDayData.basePayAmount = 0;
                currentDayData.obTotal = 0;
                currentDayData.totalPay = 0;
                currentDayData.taxAmount = 0;
                currentDayData.netPay = 0;
                currentDayData.obBreakdown = {};
                calculateAll();
                return;
            } else {
                startInput.classList.remove('error');
                endInput.classList.remove('error');
            }

            if (workMinutes < 0) workMinutes = 0; // Ensure work minutes are not negative if break is too long
            const workHours = minutesToHours(workMinutes);
            
            // Get rates
            const basePay = parseFloat(document.getElementById('basePay').value);
            const eveningRate = parseFloat(document.getElementById('eveningRate').value) / 100;
            const lateEveningRate = parseFloat(document.getElementById('lateEveningRate').value) / 100;
            const saturdayRate = parseFloat(document.getElementById('saturdayRate').value) / 100;
            const sundayRate = parseFloat(document.getElementById('sundayRate').value) / 100;
            const holidayRate = parseFloat(document.getElementById('holidayRate').value) / 100;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;

            // Calculate OB
            const ob = calculateOB(startMinutes, endMinutes, dateObj, workMinutes, isRedDay);
            
            // Calculate pay
            const basePayAmount = workHours * basePay;
            const eveningPayAmount = minutesToHours(ob.evening) * basePay * eveningRate;
            const lateEveningPayAmount = minutesToHours(ob.lateEvening) * basePay * lateEveningRate;
            const saturdayPayAmount = minutesToHours(ob.saturday) * basePay * saturdayRate;
            const sundayPayAmount = minutesToHours(ob.sunday) * basePay * sundayRate;
            const holidayPayAmount = minutesToHours(ob.holiday) * basePay * holidayRate;
            
            const obTotal = eveningPayAmount + lateEveningPayAmount + saturdayPayAmount + sundayPayAmount + holidayPayAmount;
            const totalPay = basePayAmount + obTotal;
            const taxAmount = totalPay * taxRate;
            const netPay = totalPay - taxAmount;

            // Update display
            document.getElementById(`hours_${dayId}`).textContent = workHours.toFixed(1);
            document.getElementById(`basePay_${dayId}`).textContent = Math.round(basePayAmount) + ' kr';
            document.getElementById(`obPay_${dayId}`).textContent = Math.round(obTotal) + ' kr';
            document.getElementById(`total_${dayId}`).textContent = Math.round(totalPay) + ' kr';
            document.getElementById(`tax_${dayId}`).textContent = Math.round(taxAmount) + ' kr';
            document.getElementById(`net_${dayId}`).textContent = Math.round(netPay) + ' kr';

            // Store data for this day
            currentDayData.start = startInput.value;
            currentDayData.end = endInput.value;
            currentDayData.break = breakMinutes;
            currentDayData.workHours = workHours;
            currentDayData.basePayAmount = basePayAmount;
            currentDayData.obTotal = obTotal;
            currentDayData.obBreakdown = ob; // Store breakdown for debugging/future display
            currentDayData.totalPay = totalPay;
            currentDayData.taxAmount = taxAmount;
            currentDayData.netPay = netPay;

            calculateAll(); // Update total summary after each row calculation
        }

        /**
         * Calculates and updates the total summary for all days.
         */
        function calculateAll() {
            let totalHours = 0;
            let totalBasePay = 0;
            let totalEveningPay = 0;
            let totalLateEveningPay = 0;
            let totalSaturdayPay = 0;
            let totalSundayPay = 0;
            let totalHolidayPay = 0;

            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;

            // Iterate over all days in allDaysData
            for (const dayId in allDaysData) {
                const dayData = allDaysData[dayId];

                totalHours += dayData.workHours || 0;
                totalBasePay += dayData.basePayAmount || 0;
                
                if (dayData.obBreakdown) {
                    const basePay = parseFloat(document.getElementById('basePay').value);
                    const eveningRate = parseFloat(document.getElementById('eveningRate').value) / 100;
                    const lateEveningRate = parseFloat(document.getElementById('lateEveningRate').value) / 100;
                    const saturdayRate = parseFloat(document.getElementById('saturdayRate').value) / 100;
                    const sundayRate = parseFloat(document.getElementById('sundayRate').value) / 100;
                    const holidayRate = parseFloat(document.getElementById('holidayRate').value) / 100;

                    totalEveningPay += minutesToHours(dayData.obBreakdown.evening) * basePay * eveningRate;
                    totalLateEveningPay += minutesToHours(dayData.obBreakdown.lateEvening) * basePay * lateEveningRate;
                    totalSaturdayPay += minutesToHours(dayData.obBreakdown.saturday) * basePay * saturdayRate;
                    totalSundayPay += minutesToHours(dayData.obBreakdown.sunday) * basePay * sundayRate;
                    totalHolidayPay += minutesToHours(dayData.obBreakdown.holiday) * basePay * holidayRate;
                }
            }

            const grossTotal = totalBasePay + totalEveningPay + totalLateEveningPay + totalSaturdayPay + totalSundayPay + totalHolidayPay;
            const totalTax = grossTotal * taxRate;
            const netTotal = grossTotal - totalTax;

            // Update summary display
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('totalBasePay').textContent = Math.round(totalBasePay) + ' kr';
            document.getElementById('totalEveningPay').textContent = Math.round(totalEveningPay) + ' kr';
            document.getElementById('totalLateEveningPay').textContent = Math.round(totalLateEveningPay) + ' kr';
            document.getElementById('totalSaturdayPay').textContent = Math.round(totalSaturdayPay) + ' kr';
            document.getElementById('totalSundayPay').textContent = Math.round(totalSundayPay) + ' kr';
            document.getElementById('totalHolidayPay').textContent = Math.round(totalHolidayPay) + ' kr';
            document.getElementById('grandTotal').textContent = Math.round(grossTotal) + ' kr';
            document.getElementById('taxRateDisplay').textContent = (taxRate * 100).toFixed(1);
            document.getElementById('totalTax').textContent = Math.round(totalTax) + ' kr';
            document.getElementById('netTotal').textContent = Math.round(netTotal) + ' kr';
        }

        /**
         * Removes a day row from the UI and its data.
         * @param {string} dayIdToRemove - The unique ID of the day to remove.
         */
        function removeDay(dayIdToRemove) {
            const rowToRemove = document.getElementById(`row_${dayIdToRemove}`);
            if (rowToRemove) {
                rowToRemove.remove();
                delete allDaysData[dayIdToRemove]; // Remove data for this day
                calculateAll(); // Recalculate totals
                saveData(); // Save updated data
            }
        }

        // --- Data Persistence (localStorage) ---

        /**
         * Saves all current data (settings and daily data) to localStorage.
         */
        function saveData() {
            const dataToSave = {
                settings: {
                    basePay: document.getElementById('basePay').value,
                    eveningRate: document.getElementById('eveningRate').value,
                    lateEveningRate: document.getElementById('lateEveningRate').value,
                    saturdayRate: document.getElementById('saturdayRate').value,
                    sundayRate: document.getElementById('sundayRate').value,
                    holidayRate: document.getElementById('holidayRate').value,
                    taxRate: document.getElementById('taxRate').value
                },
                allDaysData: allDaysData,
                dayCounter: dayCounter
            };
            localStorage.setItem('tidrapportData', JSON.stringify(dataToSave));
            console.log('Data saved!');
        }

        /**
         * Loads data from localStorage and populates the form.
         */
        function loadData() {
            const savedData = localStorage.getItem('tidrapportData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);

                // Load settings
                document.getElementById('basePay').value = parsedData.settings.basePay || '162.98';
                document.getElementById('eveningRate').value = parsedData.settings.eveningRate || '50';
                document.getElementById('lateEveningRate').value = parsedData.settings.lateEveningRate || '70';
                document.getElementById('saturdayRate').value = parsedData.settings.saturdayRate || '100';
                document.getElementById('sundayRate').value = parsedData.settings.sundayRate || '100';
                document.getElementById('holidayRate').value = parsedData.settings.holidayRate || '100';
                document.getElementById('taxRate').value = parsedData.settings.taxRate || '30';

                // Re-add days and populate data
                dayCounter = parsedData.dayCounter || 0; // Set dayCounter to the last saved value
                allDaysData = parsedData.allDaysData || {}; // Load allDaysData

                const tableBody = document.querySelector('#timeReportTable tbody');
                tableBody.innerHTML = ''; // Clear existing DOM rows

                // Sort days by date for chronological display
                const sortedDayIds = Object.keys(allDaysData).sort((idA, idB) => {
                    const dateA = new Date(allDaysData[idA].date);
                    const dateB = new Date(allDaysData[idB].date);
                    return dateA - dateB;
                });

                sortedDayIds.forEach(dayId => {
                    const dayData = allDaysData[dayId];
                    if (!dayData || !dayData.date) return; // Skip invalid data

                    const dateObj = new Date(dayData.date);
                    const dayName = new Intl.DateTimeFormat('sv-SE', { weekday: 'long' }).format(dateObj);
                    const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6; // Sunday or Saturday

                    const newRow = tableBody.insertRow();
                    newRow.id = `row_${dayId}`;

                    // Apply styling based on loaded data
                    if (isWeekend) {
                        newRow.classList.add('weekend');
                    }
                    if (dayData.redDay) {
                        newRow.classList.add('red-day');
                    }

                    newRow.innerHTML = `
                        <td><input type="date" class="input-field" id="date_${dayId}" value="${dayData.date}" onchange="updateDayData('${dayId}');"></td>
                        <td id="dayName_${dayId}">${dayName}</td>
                        <td><input type="checkbox" class="checkbox-field" id="redDay_${dayId}" ${dayData.redDay ? 'checked' : ''} onchange="updateRedDay('${dayId}'); saveData();"></td>
                        <td><input type="time" class="input-field" id="start_${dayId}" value="${dayData.start}" onchange="calculateRow('${dayId}'); saveData();"></td>
                        <td><input type="time" class="input-field" id="end_${dayId}" value="${dayData.end}" onchange="calculateRow('${dayId}'); saveData();"></td>
                        <td><input type="number" class="input-field" id="break_${dayId}" value="${dayData.break}" min="0" onchange="calculateRow('${dayId}'); saveData();"></td>
                        <td id="hours_${dayId}">${(dayData.workHours || 0).toFixed(1)}</td>
                        <td id="basePay_${dayId}">${Math.round(dayData.basePayAmount || 0)} kr</td>
                        <td id="obPay_${dayId}">${Math.round(dayData.obTotal || 0)} kr</td>
                        <td id="total_${dayId}">${Math.round(dayData.totalPay || 0)} kr</td>
                        <td id="tax_${dayId}">${Math.round(dayData.taxAmount || 0)} kr</td>
                        <td id="net_${dayId}">${Math.round(dayData.netPay || 0)} kr</td>
                        <td><button class="remove-day-btn" onclick="removeDay('${dayId}')">X</button></td>
                    `;
                    // Recalculate row to ensure displayed values are correct even if breakdown wasn't fully saved (or rates changed)
                    calculateRow(dayId); 
                });
                calculateAll(); // Ensure totals are updated after all days are loaded
            }
        }

        /**
         * Clears all saved data from localStorage and resets the application state.
         */
        function clearAllData() {
            if (confirm('√Ñr du s√§ker p√• att du vill rensa all sparad data? Detta kan inte √•ngras!')) {
                localStorage.removeItem('tidrapportData');
                allDaysData = {};
                dayCounter = 0;
                document.querySelector('#timeReportTable tbody').innerHTML = ''; // Clear UI
                // Reset settings to default values
                document.getElementById('basePay').value = "162.98";
                document.getElementById('eveningRate').value = "50";
                document.getElementById('lateEveningRate').value = "70";
                document.getElementById('saturdayRate').value = "100";
                document.getElementById('sundayRate').value = "100";
                document.getElementById('holidayRate').value = "100";
                document.getElementById('taxRate').value = "30";
                
                calculateAll(); // Recalculate totals (should be zero)
                console.log('All data cleared!');
            }
        }

        // --- Export Functionality ---

        /**
         * Exports all data to a CSV file.
         */
        function exportData() {
            let csv = 'Datum,Dag,R√∂d dag,Starttid,Sluttid,Rast (min),Arbetstid (timmar),Grundl√∂n (kr),OB-till√§gg (kr),Bruttol√∂n (kr),Skatt (kr),Nettol√∂n (kr)\n';
            
            // Sort days by date for chronological order in CSV
            const sortedDayIds = Object.keys(allDaysData).sort((idA, idB) => {
                const dateA = new Date(allDaysData[idA].date);
                const dateB = new Date(allDaysData[idB].date);
                return dateA - dateB;
            });

            sortedDayIds.forEach(dayId => {
                const dayData = allDaysData[dayId];
                if (dayData && dayData.date) { // Ensure data exists for the day
                    const redDay = dayData.redDay ? 'Ja' : 'Nej';
                    const dateObj = new Date(dayData.date);
                    const dayName = new Intl.DateTimeFormat('sv-SE', { weekday: 'long' }).format(dateObj);
                    
                    csv += `${dayData.date},${dayName},${redDay},${dayData.start || ''},${dayData.end || ''},${dayData.break || '0'},${(dayData.workHours || 0).toFixed(1)},${Math.round(dayData.basePayAmount || 0)},${Math.round(dayData.obTotal || 0)},${Math.round(dayData.totalPay || 0)},${Math.round(dayData.taxAmount || 0)},${Math.round(dayData.netPay || 0)}\n`;
                }
            });

            // Add summary row
            const totalHours = document.getElementById('totalHours').textContent;
            const grandTotal = document.getElementById('grandTotal').textContent.replace(' kr', '');
            const totalTax = document.getElementById('totalTax').textContent.replace(' kr', '');
            const netTotal = document.getElementById('netTotal').textContent.replace(' kr', '');
            csv += `\nSummering,,,,,,,${totalHours},,,${grandTotal},${totalTax},${netTotal}\n`;


            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tidrapport.csv';
            document.body.appendChild(a); // Append to body is good practice
            a.click();
            document.body.removeChild(a); // Clean up
            window.URL.revokeObjectURL(url);
        }

        // --- Event Listeners and Initial Setup ---

        // Add event listeners to settings inputs to trigger recalculation and saving
        document.getElementById('basePay').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('eveningRate').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('lateEveningRate').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('saturdayRate').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('sundayRate').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('holidayRate').addEventListener('input', () => { calculateAll(); saveData(); });
        document.getElementById('taxRate').addEventListener('input', () => { calculateAll(); saveData(); });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            setInterval(updateClock, 1000);
            loadData(); // Try to load saved data on page load
            if (Object.keys(allDaysData).length === 0) {
                // If no data was loaded, add an initial day for convenience
                addDay(); 
            }
        });
    </script>
</body>
</html>
